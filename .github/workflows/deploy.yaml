name: Deploy Spring Boot App to DigitalOcean

on:
  push:
    branches:
      - master
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

env:
  APP_NAME: llm-orchestrator-service
  APP_HOME: /applications/llm-orchestrator-service
  APP_PORT: 8080
  PROFILE: ollama

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: üì¶ Build Spring Boot JAR
        run: ./gradlew bootJar

      - name: üîë Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: üìÅ Create remote directories
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          mkdir -p $APP_HOME/versions
          mkdir -p $APP_HOME/.backups
          mkdir -p $APP_HOME/logs
          EOF

      - name: üíæ Save current version as previous
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          if [ -L "$APP_HOME/latest" ]; then
            CURRENT=$(basename $(readlink $APP_HOME/latest))
            echo "$CURRENT" > $APP_HOME/.backups/previous_version
            echo "Previous version saved: $CURRENT"
          fi
          EOF

      - name: üöÄ Deploy new version
        run: |
          COMMIT_ID="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_ID:0:7}"
          DEPLOY_VERSION="v_$(date +%Y%m%d_%H%M%S)_${COMMIT_SHORT}"
          
          # Create version directory on remote
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} \
            "mkdir -p $APP_HOME/versions/$DEPLOY_VERSION"
          
          # Copy JAR file
          JAR_FILE=$(find ./build/libs -name "*.jar" -type f | head -1)
          echo "Deploying JAR: $JAR_FILE"
          
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            "$JAR_FILE" \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:$APP_HOME/versions/$DEPLOY_VERSION/app.jar
          
          # Update latest symlink and save version info
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << EOF
          ln -sfn \$APP_HOME/versions/\$DEPLOY_VERSION \$APP_HOME/latest
          echo "\$DEPLOY_VERSION" > \$APP_HOME/.backups/current_version
          echo "Deployed version: \$DEPLOY_VERSION"
          EOF

      - name: üîÑ Restart application
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << EOF
          set -e
          
          # Stop the old application
          echo "Stopping old application..."
          if [ -f "$APP_HOME/app.pid" ]; then
            OLD_PID=\$(cat $APP_HOME/app.pid)
            if ps -p \$OLD_PID > /dev/null 2>&1; then
              kill \$OLD_PID
              echo "Stopped process \$OLD_PID"
              sleep 3
              # Force kill if still running
              if ps -p \$OLD_PID > /dev/null 2>&1; then
                kill -9 \$OLD_PID
                echo "Force killed process \$OLD_PID"
              fi
            fi
          fi
          
          # Start the new application
          echo "Starting new application..."
          cd $APP_HOME/latest
          nohup java -jar app.jar \
            --spring.application.name=$APP_NAME \
            --spring.profiles.active=$PROFILE \
            --server.port=$APP_PORT \
            > $APP_HOME/logs/app.log 2>&1 &
          
          NEW_PID=\$!
          echo \$NEW_PID > $APP_HOME/app.pid
          echo "‚úÖ Application started with PID: \$NEW_PID"
          
          # Wait a bit and check if process is still running
          sleep 5
          if ps -p \$NEW_PID > /dev/null 2>&1; then
            echo "‚úÖ Application is running"
          else
            echo "‚ùå Application failed to start"
            tail -50 $APP_HOME/logs/app.log
            exit 1
          fi
          EOF

      - name: ‚úÖ Verify deployment
        run: |
          sleep 5
          echo "Verifying deployment..."
          
          # Check application health
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DROPLET_IP }}:$APP_PORT/actuator/health || echo "000")
          echo "Health check status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Deployment successful! Application is running."
            # Display some logs
            ssh -i ~/.ssh/deploy_key \
              ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} \
              "tail -30 $APP_HOME/logs/app.log"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $HEALTH_STATUS"
            ssh -i ~/.ssh/deploy_key \
              ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} \
              "tail -100 $APP_HOME/logs/app.log"
            exit 1
          fi

      - name: üîÑ Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << EOF
          set -e
          
          echo "‚ö†Ô∏è Deployment failed! Starting rollback..."
          
          # Stop current app
          if [ -f "$APP_HOME/app.pid" ]; then
            PID=\$(cat $APP_HOME/app.pid)
            if ps -p \$PID > /dev/null 2>&1; then
              kill \$PID || kill -9 \$PID
              echo "Stopped failed deployment process \$PID"
            fi
          fi
          
          if [ -f "$APP_HOME/.backups/previous_version" ]; then
            PREVIOUS=\$(cat $APP_HOME/.backups/previous_version)
            if [ -d "$APP_HOME/versions/\$PREVIOUS" ]; then
              # Revert to previous version
              ln -sfn $APP_HOME/versions/\$PREVIOUS $APP_HOME/latest
              echo "\$PREVIOUS" > $APP_HOME/.backups/current_version
              
              # Restart with previous version
              cd $APP_HOME/latest
              nohup java -jar app.jar \
                --spring.application.name=$APP_NAME \
                --spring.profiles.active=$PROFILE \
                --server.port=$APP_PORT \
                > $APP_HOME/logs/app.log 2>&1 &
              
              NEW_PID=\$!
              echo \$NEW_PID > $APP_HOME/app.pid
              sleep 3
              
              echo "üîÑ Rolled back to: \$PREVIOUS"
              echo "Application PID: \$NEW_PID"
              
              if ps -p \$NEW_PID > /dev/null 2>&1; then
                echo "‚úÖ Rollback successful"
              else
                echo "‚ùå Rollback failed"
                tail -50 $APP_HOME/logs/app.log
              fi
            else
              echo "‚ùå Previous version directory not found: \$PREVIOUS"
              exit 1
            fi
          else
            echo "‚ùå No previous version found for rollback"
            exit 1
          fi
          EOF

      - name: üßπ Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
