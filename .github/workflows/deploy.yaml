name: Deploy Spring Boot App to DigitalOcean

on:
  push:
    branches:
      - master
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

env:
  APP_NAME: llm-orchestrator
  APP_HOME: /applications/llm-orchestrator
  APP_PORT: 8080

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: üì¶ Build Spring Boot JAR
        run: ./gradlew bootJar

      - name: üîë Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: üìÅ Create remote directories
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          mkdir -p $APP_HOME/versions
          mkdir -p $APP_HOME/.backups
          mkdir -p $APP_HOME/logs
          EOF

      - name: üíæ Save current version as previous
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          if [ -L "$APP_HOME/current" ]; then
            CURRENT=$(basename $(readlink $APP_HOME/current))
            echo "$CURRENT" > $APP_HOME/.backups/previous_version
            echo "Previous version saved: $CURRENT"
          fi
          EOF

      - name: üöÄ Deploy new version
        run: |
          COMMIT_ID="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_ID:0:7}"
          DEPLOY_VERSION="v_$(date +%Y%m%d_%H%M%S)_${COMMIT_SHORT}"
          
          # Create version directory on remote
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} \
            "mkdir -p $APP_HOME/versions/$DEPLOY_VERSION"
          
          # Copy JAR file
          JAR_FILE=$(find ./build/libs -name "*.jar" -type f | head -1)
          echo "Deploying JAR: $JAR_FILE"
          
          rsync -avz -e "ssh -i ~/.ssh/deploy_key" \
            "$JAR_FILE" \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:$APP_HOME/versions/$DEPLOY_VERSION/app.jar
          
          # Update current symlink and save version info
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          rm -f $APP_HOME/current
          ln -s $APP_HOME/versions/$DEPLOY_VERSION $APP_HOME/current
          echo "$DEPLOY_VERSION" > $APP_HOME/.backups/current_version
          echo "Deployed version: $DEPLOY_VERSION"
          EOF

      - name: üîÑ Restart application
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          set -e
          
          # Stop the current application
          echo "Stopping application..."
          sudo systemctl stop $APP_NAME || true
          sleep 2
          
          # Start the new application
          echo "Starting application..."
          sudo systemctl start $APP_NAME
          sleep 3
          
          # Check if application is running
          if sudo systemctl is-active --quiet $APP_NAME; then
            echo "‚úÖ Application started successfully"
          else
            echo "‚ùå Application failed to start"
            sudo journalctl -u $APP_NAME -n 50 --no-pager
            exit 1
          fi
          EOF

      - name: ‚úÖ Verify deployment
        run: |
          sleep 3
          echo "Verifying deployment..."
          
          # Check application health
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DROPLET_IP }}:$APP_PORT/actuator/health || echo "000")
          echo "Health check status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Deployment successful! Application is running."
            # Display some logs
            ssh -i ~/.ssh/deploy_key \
              ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} \
              "sudo journalctl -u $APP_NAME -n 20 --no-pager"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $HEALTH_STATUS"
            ssh -i ~/.ssh/deploy_key \
              ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} \
              "sudo journalctl -u $APP_NAME -n 50 --no-pager"
            exit 1
          fi

      - name: üîÑ Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
          set -e
          
          echo "‚ö†Ô∏è Deployment failed! Starting rollback..."
          
          if [ -f "$APP_HOME/.backups/previous_version" ]; then
            PREVIOUS=$(cat $APP_HOME/.backups/previous_version)
            if [ -d "$APP_HOME/versions/$PREVIOUS" ]; then
              # Stop current app
              sudo systemctl stop $APP_NAME || true
              sleep 2
              
              # Revert to previous version
              rm -f $APP_HOME/current
              ln -s $APP_HOME/versions/$PREVIOUS $APP_HOME/current
              echo "$PREVIOUS" > $APP_HOME/.backups/current_version
              
              # Restart with previous version
              sudo systemctl start $APP_NAME
              sleep 3
              
              echo "üîÑ Rolled back to: $PREVIOUS"
              echo "Application status:"
              sudo systemctl status $APP_NAME
            else
              echo "‚ùå Previous version directory not found: $PREVIOUS"
              exit 1
            fi
          else
            echo "‚ùå No previous version found for rollback"
            exit 1
          fi
          EOF

      - name: üßπ Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
